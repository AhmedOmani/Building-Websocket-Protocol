<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Echo Demo</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                    <h1>WebSocket Echo Demo</h1>
                </div>
                <div class="connection-controls">
                    <button id="open_ws" class="btn btn-primary">
                        <i class="fas fa-plug"></i>
                        <span>Connect</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Status Section -->
        <section class="status-section">
            <div class="status-card">
                <div class="status-indicator" id="status-indicator"></div>
                <div class="status-text">
                    <span id="status">Not connected</span>
                    <small id="connection-details"></small>
                </div>
            </div>
        </section>

        

        <!-- Message Section -->
        <section class="message-section">
            <div class="message-header">
                <h3><i class="fas fa-comments"></i> Messages</h3>
                <div class="message-stats">
                    <span id="message-count">0 messages</span>
                    <span id="total-bytes">0 bytes</span>
                </div>
            </div>
            <div class="message-container">
                <div id="table" class="message-list"></div>
            </div>
        </section>

        <!-- Input Section -->
        <section class="input-section">
            <form id="form" class="message-form">
                <div class="input-group">
                    <textarea id="message" placeholder="Type your message here... (Connect to WebSocket first)" required></textarea>
                    <div class="char-counter">
                        <span id="char-count">0</span> characters
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-success" id="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Send Message
                    </button>
                    <button id="populate" type="button" class="btn btn-secondary">
                        <i class="fas fa-magic"></i>
                        Populate
                    </button>
                    <button id="close_ws" type="button" class="btn btn-danger" disabled>
                        <i class="fas fa-times"></i>
                        Disconnect
                    </button>
                </div>
            </form>
        </section>
    </div>
        <script>
            // *** DOM ELEMENTS ***
            let open_ws_btn = document.getElementById("open_ws");
            let close_ws_btn = document.getElementById("close_ws");
            let send_btn = document.getElementById("send-btn");
            let populate_btn = document.getElementById("populate");
            let form = document.getElementById("form");
            let socketStatus = document.getElementById("status");
            let statusIndicator = document.getElementById("status-indicator");
            let connectionDetails = document.getElementById("connection-details");
            let table = document.getElementById("table");
            let message = document.getElementById("message");
            let charCount = document.getElementById("char-count");
            let messageCount = document.getElementById("message-count");
            let totalBytes = document.getElementById("total-bytes");

            // *** MESSAGE TRACKING ***
            let messageCounter = 0;
            let totalBytesSent = 0;

            let text = "A".repeat(999999);

            // *** HELPER FUNCTIONS ***
            function updateStatus(status, details = "", indicatorClass = "disconnected") {
                socketStatus.textContent = status;
                connectionDetails.textContent = details;
                statusIndicator.className = `status-indicator ${indicatorClass}`;
            }

            function updateMessageStats() {
                messageCount.textContent = `${messageCounter} message${messageCounter !== 1 ? 's' : ''}`;
                totalBytes.textContent = `${totalBytesSent.toLocaleString()} bytes`;
            }

            function addMessage(content, type, size) {
                messageCounter++;
                totalBytesSent += size;
                updateMessageStats();

                const messageElement = document.createElement('div');
                messageElement.className = `message-item ${type}`;
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-type">
                            <i class="fas fa-${type === 'sent' ? 'paper-plane' : 'reply'}"></i>
                            ${type.toUpperCase()}
                        </span>
                        <span class="message-size">${size.toLocaleString()} bytes</span>
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">${content}</div>
                `;
                
                table.appendChild(messageElement);
                table.scrollTop = table.scrollHeight;
            }

            // *** WEBSOCKET SERVER ***
            open_ws_btn.addEventListener("click", () => {
                // Button styling
                open_ws_btn.disabled = true;
                open_ws_btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Connecting...</span>';
                
                // Reset stats
                messageCounter = 0;
                totalBytesSent = 0;
                updateMessageStats();
                table.innerHTML = '';
                
                // Update status
                updateStatus("Connecting...", "", "connecting");
                
                // Define websocket server location
                let url = "ws://127.0.0.1:3001";
                let socket = new WebSocket(url);
                
                // OPEN EVENT
                socket.onopen = (openEvent) => {
                    console.log("SOCKET CONNECTING STATUS IS: " + socket.readyState);
                    
                    // Update UI
                    open_ws_btn.disabled = false;
                    open_ws_btn.innerHTML = '<i class="fas fa-plug"></i> <span>Connected</span>';
                    send_btn.disabled = false;
                    close_ws_btn.disabled = false;
                    message.placeholder = "Type your message here...";
                    updateStatus("Connected", openEvent.currentTarget.url, "connected");
                    
                    populate_btn.addEventListener("click", () => {
                        message.value = text;
                        updateCharCount();
                    });
                }

                // MESSAGE EVENT: handle messages when they are received from server
                socket.onmessage = function(event) {
                   console.log("Received message:", event);
                   const messageSize = new Blob([event.data]).size;
                   addMessage(event.data, 'received', messageSize);
                };

                // CLOSE EVENT
                socket.onclose = (closeEventObject) => {
                    console.log("CLOSE EVENT FIRED. CLOSE OBJECT", closeEventObject);
                    
                    // Reset buttons
                    open_ws_btn.disabled = false;
                    open_ws_btn.innerHTML = '<i class="fas fa-plug"></i> <span>Connect</span>';
                    send_btn.disabled = true;
                    close_ws_btn.disabled = true;
                    message.placeholder = "Type your message here... (Connect to WebSocket first)";
                    
                    // Update status based on close code
                    switch (closeEventObject.code) {
                        case 1006:
                            updateStatus("Connection Lost", "Network error", "error");
                            break;
                        case 1001:
                            updateStatus("Disconnected", closeEventObject.reason || "Server closed connection", "disconnected");
                            break;
                        default:
                            updateStatus("Disconnected", "Connection closed by user", "disconnected");
                    }
                };

                // ERROR EVENT
                socket.onerror = (error) => {
                    console.log("Error event was thrown. ERROR OBJECT: ", error);
                    updateStatus("Connection Error", "Failed to establish connection", "error");
                }

                // *** CHARACTER COUNTER ***
                function updateCharCount() {
                    charCount.textContent = message.value.length;
                }
                
                message.addEventListener('input', updateCharCount);

                // *** SEND METHOD
                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    if(socket.readyState === 1) {
                        let user_text = message.value;
                        const messageSize = new Blob([user_text]).size;
                        
                        socket.send(user_text);
                        addMessage(user_text, 'sent', messageSize);
                        message.value = "";
                        updateCharCount();
                    }
                });

                // *** CLOSE METHOD
                close_ws_btn.addEventListener("click", () => {
                    updateStatus("Closing...", "Please wait", "connecting");
                    socket.close(1000, "User requested disconnect");
                    message.removeAttribute("required");
                    form.classList.remove("show");
                });
            });
        </script>
    </body>
</html>